<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Valentines Challenge Event</title>
  </head>
  <style media="screen">
    html{
      font-size: 3vw;
    }
    .header{
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      flex-wrap: wrap;
      align-items: center;
      z-index: 2;
    }
    .header > * {
      border: 1px solid black;
      padding: 5px;
    }
    #projected{
      content: "This is only a current estimate of your time compared to everyone elses, as others drop out and your drop out, this number will change";
    }
    #targetarea{
      width: 40vh;
      height: 40vh;
      background-size: cover;
      background-image: url("https://cdn.pixabay.com/photo/2017/05/30/08/31/heart-2356169_1280.png");
    }
    #targetareacontainer{
      display: grid;
      justify-content: center;
    }
  </style>
  <body>
    <div class="header">
      <span>Player Name: {{player.name}}</span>
      <span>Game Status:

        {% if player.presetchallenger.active %}
          Playing
        {% else %}
          Game Over: Spectating
        {% endif %}

      </span>
      <span>Time Held: <span id="time_held">XX</span> seconds</span>
      <span>Game Time Left: <span id="time_left">{{time_left}}</span> seconds</span>
      <span>Total Time Percentage: <span id="percent"></span> </span>
      <span id="projected">Projected Candy Reward: <span id="Pcandies"></span></span>
    </div>
    <div id="targetareacontainer">
      <button aria-pressed="false"id="targetarea">
      </button>
    </div>

  </body>

  <script type="text/javascript">
  // blocking scrolling code
  // left: 37, up: 38, right: 39, down: 40,
// spacebar: 32, pageup: 33, pagedown: 34, end: 35, home: 36
var keys = {37: 1, 38: 1, 39: 1, 40: 1};

function preventDefault(e) {
  e.preventDefault();
}

function preventDefaultForScrollKeys(e) {
  if (keys[e.keyCode]) {
    preventDefault(e);
    return false;
  }
}

// modern Chrome requires { passive: false } when adding event
var supportsPassive = false;
try {
  window.addEventListener("test", null, Object.defineProperty({}, 'passive', {
    get: function () { supportsPassive = true; }
  }));
} catch(e) {}

var wheelOpt = supportsPassive ? { passive: false } : false;
var wheelEvent = 'onwheel' in document.createElement('div') ? 'wheel' : 'mousewheel';

// call this to Disable
function disableScroll() {
  window.addEventListener('DOMMouseScroll', preventDefault, false); // older FF
  window.addEventListener(wheelEvent, preventDefault, wheelOpt); // modern desktop
  window.addEventListener('touchmove', preventDefault, wheelOpt); // mobile
  window.addEventListener('keydown', preventDefaultForScrollKeys, false);
}

/* gameStage
  0 - not started
  1 - started
  2 - ended
*/
// gameStage = 0;

{% if player.presetchallenger.active %}
gameStage = 0;
{% else %}
  gameStage = 2;
{% endif %}
  var start_time_js;
  var time_held = 0;
  function updateTimeHeld(){
    ele = document.querySelector("#time_held");
    ele.innerHTML = time_held;
  }

  var targetarea = document.querySelector("#targetarea");
  var targetareacontainer = document.querySelector("#targetareacontainer");

  var pressedInvervalCheck;

  function startgame(){
    console.log("Starting Game");

    // establish http request loop connnection with server with time out failure built in

    pressedInvervalCheck = setInterval(checkIfPressed, 100);

    // if it has reached x > 5 seconds, then send to server
    // recieve update from server, update game time left, time percentage, project candy
    sendToServer = setInterval(sendToServer, 5000);
  }
  function endgame(){
    console.log("Ending Game");
    clearInterval(pressedInvervalCheck);
    clearInterval(sendToServer);

  }
  function sendToServer(){
    var xhr = new XMLHttpRequest();
    xhr.open("post", '.', true);
    xhr.setRequestHeader("X-CSRFToken", "{{csrf_token}}");
    xhr.setRequestHeader("Content-Type", "text/plain");
    xhr.onreadystatechange = function (){
      if (xhr.readyState === 4){
        var data=xhr.responseText;
        var data = JSON.parse(data);
        // data = data["Data"];
        // console.log(data);

        let ele = document.querySelector("#time_left");
        ele.innerHTML = data.time_left;
        // data.percent is decimil percent of total time
        percent = (Math.ceil(data.time_held / data.total_time) * 100);
        candies = Math.ceil(percent / 4);
        ele = document.querySelector("#percent");
        ele.innerHTML = percent;
        ele = document.querySelector("#Pcandies");
        ele.innerHTML = candies;
      }
    }
    var outdata = {{player.code}}
    xhr.send(outdata);

  }
  function checkIfPressed(){
    console.log("updating time");
    console.log(targetarea.ariaPressed);
    if (targetarea.ariaPressed){
      // update the total time in seconds using time
      let d = new Date();
      time_held = (d.getTime() - start_time_js)/1000;
      updateTimeHeld();
    }else{
      // kill the game
      UpdateGame(1);
    }

  }

  // changes gameStage, assume it has changed
  function UpdateGame(change){
    gameStage += change;
    console.log('update to game, now stage: ' + gameStage);
    switch (gameStage) {
      case 1:
        let d = new Date();
        start_time_js = d.getTime();
        startgame();
        break;
      case 2:
        endgame();
        break;
    }
  }
  // web sockets functions
/*
Client:
Start game
end game
continue game

Server:
Recieved Start Game
End game
Update time

*/

window.addEventListener('load', (event) => {
  console.log('page is fully loaded');

  disableScroll();
  // load time status of page/ countdown
  updateTimeHeld();
  // preprare event listeners
  /*
  event change on the target div -> change status of variable
  */

  // on press + release
  targetareacontainer.onmousedown = function(){UpdateGame(1)};
  targetareacontainer.onmouseup = function(){UpdateGame(1)};
  var onlongtouch;
var timer;
var touchduration = 800; //length of time we want the user to touch before we do something

function touchstart(e) {
    e.preventDefault();
    if (!timer) {
        timer = setTimeout(onlongtouch, touchduration);
    }
}

function touchend() {
    //stops short touches from firing the event
    if (timer) {
        clearTimeout(timer);
        timer = null;
    }
}

onlongtouch = function() {
    timer = null;
    targetareacontainer.innerText+='ping\n';
};

document.addEventListener("DOMContentLoaded", function(event) {
    window.addEventListener("touchstart", touchstart, false);
    window.addEventListener("touchend", touchend, false);
});

});

  </script>
</html>
